<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NIV – minimal test</title>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        position: fixed;
        inset: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <script>
      // 1) Osnovna raster mapa (bez ikakvog HTML-a u stringovima)
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
          sources: {
            osm: {
              type: "raster",
              tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
              tileSize: 256,
              attribution: "© OpenStreetMap contributors",
            },
          },
          layers: [{ id: "osm", type: "raster", source: "osm" }],
        },
        center: [19.8335, 45.2671],
        zoom: 7,
      });
      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // 2) Učitavanje GeoJSON-a — apsolutna putanja
      map.on("load", async () => {
        try {
          const r = await fetch("/data/places.geojson", { cache: "no-store" });
          if (!r.ok) throw new Error("HTTP " + r.status);
          const data = await r.json();

          map.addSource("places", { type: "geojson", data });
          map.addLayer({
            id: "places-circles",
            type: "circle",
            source: "places",
            paint: {
              "circle-radius": 6,
              "circle-color": "#1f7a8c",
              "circle-stroke-width": 1,
              "circle-stroke-color": "#ffffff",
            },
          });

          // 3) Popup bez HTML-a (setText)
          const popup = new maplibregl.Popup({
            closeButton: true,
            closeOnClick: true,
          });
          map.on("click", "places-circles", (e) => {
            const f = e.features && e.features[0];
            if (!f) return;
            const p = f.properties || {};
            popup
              .setLngLat(e.lngLat)
              .setText(
                (p.naziv || "Bez naziva") +
                  (p.kategorija ? " – " + p.kategorija : "")
              )
              .addTo(map);
          });

          map.on(
            "mouseenter",
            "places-circles",
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            "places-circles",
            () => (map.getCanvas().style.cursor = "")
          );
        } catch (err) {
          console.error("GeoJSON load error:", err);
          alert("Ne mogu da učitam /data/places.geojson");
        }
      });
    </script>
  </body>
</html>
