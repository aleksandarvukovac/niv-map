<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Najbolje iz Vojvodine – mapa</title>

    <!-- MapLibre -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

    <style>
      :root {
        --fg: #1a1a1a;
        --muted: #5d5d5d;
        --accent: #1f7a8c;
        --card-w: 260px;
        --radius: 14px;
        --pad: 12px;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }

      .badge {
        position: absolute;
        left: 12px;
        top: 12px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 10px;
        padding: 6px 10px;
        font: 13px/1.35 system-ui, Arial;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      /* ===== custom marker ===== */
      .custom-marker {
        cursor: pointer;
        user-select: none;
        pointer-events: auto;
      }
      .custom-marker svg {
        width: 34px;
        height: 44px;
        display: block;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
      }

      /* ===== kompaktan popup ===== */
      .maplibregl-popup {
        max-width: var(--card-w) !important;
      }
      .maplibregl-popup-content {
        padding: 0;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.18);
      }
      .maplibregl-popup-close-button {
        top: 6px;
        right: 8px;
      }

      .card {
        width: var(--card-w);
        max-height: 380px;
        overflow: auto;
      }
      .card_media {
        position: relative;
        background: #f6f7f8;
      }
      .card_img {
        display: block;
        width: 100%;
        height: 160px;
        object-fit: cover;
      }
      .card_body {
        padding: var(--pad);
        font: 13px/1.42 system-ui, Arial;
        color: var(--fg);
      }
      .card_title {
        margin: 0 0 0.35rem;
        font-size: 15px;
        font-weight: 650;
      }
      .muted {
        color: var(--muted);
      }
      .card_link {
        color: var(--accent);
        text-decoration: none;
      }
      .card_link:hover {
        text-decoration: underline;
      }

      /* carousel kontrole */
      .navbtn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 26px;
        height: 26px;
        border: none;
        border-radius: 99px;
        background: rgba(255, 255, 255, 0.95);
        display: grid;
        place-items: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        cursor: pointer;
      }
      .navbtn--prev {
        left: 8px;
      }
      .navbtn--next {
        right: 8px;
      }
      .dots {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 6px;
        display: flex;
        gap: 6px;
        justify-content: center;
      }
      .dots i {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
      }
      .dots i.on {
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="badge">
      Najbolje iz Vojvodine — demo ·
      <a href="/embed.html" target="_blank">Kopiraj link</a>
    </div>

    <script>
      // 1) Map style (MapTiler)
      const MAPTILER_KEY = "WJJJqPPstboZWo4827qc";
      const STYLE_URL = `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`;

      // 2) Init mapa
      const map = new maplibregl.Map({
        container: "map",
        style: STYLE_URL,
        center: [19.8335, 45.2671],
        zoom: 7.2,
        attributionControl: true,
      });
      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // 3) Učitavanje podataka
      async function loadData() {
        const r = await fetch("/data/places.geojson", { cache: "no-store" });
        if (!r.ok) throw new Error("Ne mogu da učitam /data/places.geojson");
        return r.json();
      }
      
      // 4) INLINE SVG MARKERA (popunjen, kontrastan)
      //   – nema fetch-a → nema CORS/404; lako menjaš boje/veličinu
      const PIN_SVG = `
        <svg viewBox="0 0 40 52" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="pinGradient" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#1f7a8c"/>
              <stop offset="1" stop-color="#176273"/>
            </linearGradient>
          </defs>
          <!-- telo pina - puno, bez providnosti -->
          <path d="M20 1C10.1 1 2 9.1 2 19c0 10.3 9 19.5 16.2 30.7a2 2 0 0 0 3.5 0C29 38.5 38 29.3 38 19 38 9.1 29.9 1 20 1z"
                fill="url(#pinGradient)" stroke="#0e3d45" stroke-width="2"/>
          <!-- bela pločica unutra -->
          <circle cx="20" cy="19" r="10.5" fill="#ffffff" stroke="#0e3d45" stroke-width="1.5"/>
          <!-- alatke (ikonica zanata) -->
          <path d="M16.2 14.5l-3 2.8a.9.9 0 0 0 0 1.3l2 2a.9.9 0 0 0 1.3 0l2.8-3 4.7 4.7a1 1 0 0 0 1.4 0l1-1a1 1 0 0 0 0-1.4l-4.8-4.7 3-2.9a.9.9 0 0 0 0-1.3l-2-2a.9.9 0 0 0-1.2 0l-2.9 3-2-2a.9.9 0 0 0-1.3 0l-1 1a.9.9 0 0 0 0 1.3l2 1.9z"
                fill="#0e3d45"/>
        </svg>`;

      // Test marker - simple red circle
      const TEST_MARKER = `
        <div style="width: 30px; height: 30px; background: red; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
      `;

      // Cache busting for development
      console.log('NIV Map loaded - version:', new Date().toISOString());
      console.log('PIN_SVG length:', PIN_SVG.length);
      console.log('PIN_SVG preview:', PIN_SVG.substring(0, 100) + '...');

      // helper: normalizuj CSV foto listu → apsolutni put
      // SAMO fotke iz CSV/GeoJSON (bez fallbacka)
      const normPhotos = (fotoString) => {
        if (!fotoString) return [];
        return String(fotoString)
          .split(',')
          .map(s => s.trim())
          .filter(Boolean)
          .filter(u => /\.(png|jpe?g|webp|gif|svg)$/i.test(u))
          .map(u => u.startsWith('/') ? u : `/${u}`);
      };

      // popup HTML + carousel
      function buildCarousel(arr, alt) {
        if (!arr.length) return "";
        const dots = arr
          .map((_, i) => `<i class="${i === 0 ? "on" : ""}"></i>`)
          .join("");
        return `
          <div class="card_media" data-count="${arr.length}">
            <img class="card_img" src="${arr[0]}" alt="${
          alt || "Foto"
        }" data-idx="0"/>
            ${
              arr.length > 1
                ? `
              <button class="navbtn navbtn--prev" aria-label="Prethodna">‹</button>
              <button class="navbtn navbtn--next" aria-label="Sledeća">›</button>
              <div class="dots">${dots}</div>`
                : ""
            }
          </div>`;
      }
      function popupHTML(p) {
        const photos = normPhotos(p.foto);
        return `
          <article class="card">
            ${buildCarousel(photos, p.naziv)}
            <div class="card_body">
              <h3 class="card_title">${p.naziv ?? ""}</h3>
              ${
                p.kategorija
                  ? `<div class="muted"><strong>Kategorija:</strong> ${p.kategorija}</div>`
                  : ""
              }
              ${
                p.opis
                  ? `<p class="muted" style="margin:.45rem 0 0">${p.opis}</p>`
                  : ""
              }
              ${
                p.web
                  ? `<p style="margin:.55rem 0 0"><a class="card_link" href="${p.web}" target="_blank" rel="noopener">Web sajt ⇗</a></p>`
                  : ""
              }
            </div>
          </article>`;
      }
      function wireCarousel(container, items) {
        const wrap = container.querySelector(".card_media");
        if (!wrap) return;
        const img = wrap.querySelector(".card_img");
        const prev = wrap.querySelector(".navbtn--prev");
        const next = wrap.querySelector(".navbtn--next");
        const dots = wrap.querySelectorAll(".dots i");
        let idx = 0;
        const go = (to) => {
          idx = (to + items.length) % items.length;
          img.src = items[idx];
          img.dataset.idx = String(idx);
          dots.forEach((d, i) => d.classList.toggle("on", i === idx));
        };
        prev &&
          prev.addEventListener("click", (e) => {
            e.stopPropagation();
            go(idx - 1);
          });
        next &&
          next.addEventListener("click", (e) => {
            e.stopPropagation();
            go(idx + 1);
          });
        dots.forEach((d, i) =>
          d.addEventListener("click", (e) => {
            e.stopPropagation();
            go(i);
          })
        );
      }

      map.on("load", async () => {
        const data = await loadData();
        const popup = new maplibregl.Popup({
          closeButton: true,
          closeOnClick: true,
        });

        data.features.forEach((f) => {
          const p = f.properties || {};
          const [lng, lat] = f.geometry.coordinates;

          // DOM element markera - eksplicitno postavljamo stilove
          const el = document.createElement("div");
          el.className = "custom-marker";
          el.style.width = "34px";
          el.style.height = "44px";
          el.style.cursor = "pointer";
          el.style.pointerEvents = "auto";
          el.innerHTML = PIN_SVG;
          
          console.log('Creating marker for:', p.naziv, 'at', [lng, lat]); // debug
          console.log('Element HTML:', el.outerHTML.substring(0, 200)); // debug
          
          const marker = new maplibregl.Marker(el)
            .setLngLat([lng, lat])
            .addTo(map);

          // Klik na marker
          el.addEventListener("click", (e) => {
            e.stopPropagation();
            e.preventDefault();
            
            const photos = normPhotos(p.foto);
            console.log('Marker clicked, photos:', photos); // debug
            
            popup.setLngLat([lng, lat]).setHTML(popupHTML(p)).addTo(map);
            
            // Vežemo karusel nakon što je popup u DOM-u
            setTimeout(() => {
              const container = document.querySelector(".maplibregl-popup-content");
              if (container && photos.length > 1) {
                wireCarousel(container, photos);
              }
            }, 100);
          });
        });
      });
    </script>
  </body>
</html>
