<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Najbolje iz Vojvodine – mapa</title>

    <!-- MapLibre -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
      .badge {
        position: absolute;
        left: 12px;
        top: 12px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 8px 10px;
        font: 14px/1.3 system-ui, Arial, sans-serif;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }
      .popup {
        font: 14px/1.45 system-ui, Arial, sans-serif;
        max-width: 280px;
      }
      .popup h3 {
        margin: 0 0 0.35rem;
        font-size: 16px;
      }
      .popup p {
        margin: 0.25rem 0;
      }
      .popup a {
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="badge">
      Najbolje iz Vojvodine — demo ·
      <a href="/embed.html" target="_blank">Kopiraj link</a>
    </div>

    <script>
      // === 1) MapTiler ključ & stil ===
      const MAPTILER_KEY = "WJJJqPPstboZWo4827qc"; // po želji kasnije prebaci u zaseban config fajl
      const STYLE_URL = `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`;

      // === 2) Inicijalizuj mapu (MapLibre + MapTiler stil) ===
      const map = new maplibregl.Map({
        container: "map",
        style: STYLE_URL,
        center: [19.8335, 45.2671], // Novi Sad
        zoom: 7.3,
        attributionControl: true,
      });

      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // === 3) Učitaj GeoJSON tačke ===
      async function loadData() {
        const res = await fetch("/data/places.geojson");
        if (!res.ok) throw new Error("Ne mogu da učitam /data/places.geojson");
        return await res.json();
      }

      map.on("load", async () => {
        try {
          const data = await loadData();

          map.addSource("places", { type: "geojson", data });

          // krugovi
          map.addLayer({
            id: "places-circles",
            type: "circle",
            source: "places",
            paint: {
              "circle-radius": 6,
              "circle-color": "#1f7a8c",
              "circle-stroke-width": 1,
              "circle-stroke-color": "#ffffff",
            },
          });

          // etikete
          map.addLayer({
            id: "places-labels",
            type: "symbol",
            source: "places",
            layout: {
              "text-field": ["get", "naziv"],
              "text-size": 12,
              "text-offset": [0, 1.1],
              "text-anchor": "top",
            },
            paint: { "text-halo-color": "#fff", "text-halo-width": 1 },
          });

          // popup
          const popup = new maplibregl.Popup({
            closeButton: true,
            closeOnClick: true,
          });
          map.on("click", "places-circles", (e) => {
            const f = e.features[0];
            const p = f.properties || {};
            const html = `
          <div class="popup">
            <h3>${p.naziv ?? ""}</h3>
            ${
              p.kategorija
                ? `<p><strong>Kategorija:</strong> ${p.kategorija}</p>`
                : ""
            }
            ${p.opis ? `<p>${p.opis}</p>` : ""}
            ${
              p.web
                ? `<p><a href="${p.web}" target="_blank" rel="noopener">Web sajt ⇗</a></p>`
                : ""
            }
            ${
              p.foto
                ? `<img src="${p.foto}" alt="${
                    p.naziv ?? "Foto"
                  }" style="width:100%; border-radius:8px; margin-top:.25rem">`
                : ""
            }
          </div>`;
            popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
          });

          map.on(
            "mouseenter",
            "places-circles",
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            "places-circles",
            () => (map.getCanvas().style.cursor = "")
          );
        } catch (err) {
          console.error(err);
          alert("Podaci nisu učitani. Proveri /data/places.geojson");
        }
      });
    </script>
  </body>
</html>
