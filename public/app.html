<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Najbolje iz Vojvodine – mapa</title>

    <!-- MapLibre -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

    <style>
      :root {
        --card-w: 260px;
        --card-pad: 12px;
        --card-radius: 12px;
        --fg: #1a1a1a;
        --muted: #5b5b5b;
        --accent: #1f7a8c;
      }

      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }

      .badge {
        position: absolute;
        left: 12px;
        top: 12px;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 10px;
        padding: 6px 9px;
        font: 13px/1.35 ui-sans-serif, system-ui, Arial;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      /* ==== kompaktan popup ==== */
      .maplibregl-popup {
        max-width: var(--card-w);
      }
      .maplibregl-popup-content {
        padding: 0;
        border-radius: var(--card-radius);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
      }
      .maplibregl-popup-close-button {
        top: 6px;
        right: 8px;
      }

      .card {
        width: var(--card-w);
        max-height: 400px;
        overflow: auto;
        background: #fff;
      }
      .card_media {
        position: relative;
        background: #f6f7f8;
      }
      .card_img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
        border-bottom: 1px solid #eee;
      }
      /* pin-maska za sliku u popapu */
      .card_img.pin {
        -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 260"><path d="M100 5a85 85 0 0 0-85 85c0 59 85 165 85 165s85-106 85-165A85 85 0 0 0 100 5z" fill="%23000"/></svg>');
        mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 260"><path d="M100 5a85 85 0 0 0-85 85c0 59 85 165 85 165s85-106 85-165A85 85 0 0 0 100 5z" fill="%23000"/></svg>');
        -webkit-mask-size: contain;
        mask-size: contain;
        -webkit-mask-position: center top;
        mask-position: center top;
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        padding: 6px;
        height: 160px;
        background: #fff;
        border-bottom: none;
      }

      .card_body {
        padding: var(--card-pad);
        font: 13px/1.45 ui-sans-serif, system-ui, Arial;
        color: var(--fg);
      }
      .card_title {
        margin: 0 0 0.4rem;
        font-size: 15px;
        font-weight: 650;
      }
      .card_meta {
        margin: 0.25rem 0;
        color: var(--muted);
      }
      .card_link {
        color: var(--accent);
        text-decoration: none;
      }
      .card_link:hover {
        text-decoration: underline;
      }

      /* mini karusel */
      .navbtn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 26px;
        height: 26px;
        border: none;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        cursor: pointer;
        display: grid;
        place-items: center;
      }
      .navbtn:hover {
        background: #fff;
      }
      .navbtn--prev {
        left: 8px;
      }
      .navbtn--next {
        right: 8px;
      }
      .dots {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 6px;
        display: flex;
        gap: 6px;
        justify-content: center;
      }
      .dots i {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
      }
      .dots i.on {
        background: #fff;
      }

      /* HTML marker – zanati pin */
      .marker-zanat {
        width: 28px;
        height: 28px;
        background: url("/img/kategorije/zanat-pin.svg") center / contain
          no-repeat;
        transform: translate(-50%, -100%); /* anchor: bottom */
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="badge">
      Najbolje iz Vojvodine — demo ·
      <a href="/embed.html" target="_blank">Kopiraj link</a>
    </div>

    <script>
      // 1) Map style (MapTiler)
      const MAPTILER_KEY = "WJJJqPPstboZWo4827qc";
      const STYLE_URL = `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`;

      // 2) Map init
      const map = new maplibregl.Map({
        container: "map",
        style: STYLE_URL,
        center: [19.8335, 45.2671], // Novi Sad
        zoom: 7.2,
        attributionControl: true,
      });
      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // 3) Učitavanje GeoJSON-a
      async function loadData() {
        const res = await fetch("/data/places.geojson", { cache: "no-store" });
        if (!res.ok) throw new Error("Ne mogu da učitam /data/places.geojson");
        return res.json();
      }

      // Helper: HTML za karusel (slike iz CSV kolone 'foto')
      function buildCarouselHTML(fotoCsv, altText) {
        const imgs = (fotoCsv || "")
          .split(",")
          .map((x) => x.trim())
          .filter(Boolean);

        if (!imgs.length) return "";

        const dots = imgs
          .map(
            (_, i) => `<i class="${i === 0 ? "on" : ""}" data-idx="${i}"></i>`
          )
          .join("");

        return `
          <div class="card_media" data-count="${imgs.length}">
            <img class="card_img pin" src="${imgs[0]}" alt="${
          altText || "Foto"
        }" data-idx="0">
            ${
              imgs.length > 1
                ? `
              <button class="navbtn navbtn--prev" aria-label="Prethodna">‹</button>
              <button class="navbtn navbtn--next" aria-label="Sledeća">›</button>
              <div class="dots">${dots}</div>
            `
                : ``
            }
            <template data-images>${imgs
              .map((s) => `<span>${s}</span>`)
              .join("")}</template>
          </div>
        `;
      }

      function wireCarousel(root) {
        const media = root.querySelector(".card_media");
        if (!media) return;

        const imgEl = media.querySelector("img.card_img");
        const templ = media.querySelector("template[data-images]");
        const urls = Array.from(templ.content.children).map(
          (n) => n.textContent
        );
        let idx = 0;

        const dots = root.querySelectorAll(".dots i");
        const setActive = (i) => {
          idx = (i + urls.length) % urls.length;
          imgEl.src = urls[idx];
          imgEl.dataset.idx = String(idx);
          dots.forEach((d, j) => d.classList.toggle("on", j === idx));
        };

        const prev = root.querySelector(".navbtn--prev");
        const next = root.querySelector(".navbtn--next");
        prev &&
          prev.addEventListener("click", (e) => {
            e.stopPropagation();
            setActive(idx - 1);
          });
        next &&
          next.addEventListener("click", (e) => {
            e.stopPropagation();
            setActive(idx + 1);
          });
        dots.forEach((d) =>
          d.addEventListener("click", (e) => {
            e.stopPropagation();
            const i = Number(d.getAttribute("data-idx"));
            if (!Number.isNaN(i)) setActive(i);
          })
        );
      }

      function buildPopupHTML(p) {
        const media = buildCarouselHTML(p.foto, p.naziv);
        return `
          <article class="card">
            ${media}
            <div class="card_body">
              <h3 class="card_title">${p.naziv ?? ""}</h3>
              ${
                p.kategorija
                  ? `<div class="card_meta"><strong>Kategorija:</strong> ${p.kategorija}</div>`
                  : ``
              }
              ${p.opis ? `<p>${p.opis}</p>` : ``}
              ${
                p.web
                  ? `<p><a class="card_link" href="${p.web}" target="_blank" rel="noopener">Web sajt ⇗</a></p>`
                  : ``
              }
            </div>
          </article>
        `;
      }

      const popup = new maplibregl.Popup({
        closeButton: true,
        closeOnClick: true,
      });

      // 4) Markeri (HTML marker sa tvojim pinom) + popup
      map.on("load", async () => {
        try {
          const data = await loadData();

          data.features.forEach((f) => {
            const p = f.properties || {};
            const [lng, lat] = f.geometry.coordinates;

            // HTML marker
            const el = document.createElement("div");
            el.className = "marker-zanat";

            const marker = new maplibregl.Marker({
              element: el,
              anchor: "bottom",
            })
              .setLngLat([lng, lat])
              .addTo(map);

            el.addEventListener("click", (ev) => {
              ev.stopPropagation();
              const html = buildPopupHTML(p);
              popup.setLngLat([lng, lat]).setHTML(html).addTo(map);
              // oživi karusel kada se popup ubaci u DOM
              const root = document.querySelector(".maplibregl-popup");
              root && wireCarousel(root);
            });
          });
        } catch (err) {
          console.error(err);
          alert("Podaci nisu učitani. Proveri /data/places.geojson");
        }
      });
    </script>
  </body>
</html>
