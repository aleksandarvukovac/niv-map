<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Najbolje iz Vojvodine ‚Äì mapa</title>

    <!-- MapLibre -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

    <style>
      :root {
        --fg: #1a1a1a;
        --muted: #5d5d5d;
        --accent: #1f7a8c;
        --card-w: 260px;
        --radius: 14px;
        --pad: 12px;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }

      .badge {
        position: absolute;
        left: 12px;
        top: 12px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 10px;
        padding: 6px 10px;
        font: 13px/1.35 system-ui, Arial;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      /* ===== modern marker styles ===== */
      .modern-marker {
        position: relative;
        cursor: pointer;
        user-select: none;
        pointer-events: auto;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .modern-marker:hover {
        transform: scale(1.1);
        z-index: 1000;
      }
      
      .marker-pin {
        width: 32px;
        height: 32px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border: 3px solid rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .marker-icon {
        transform: rotate(45deg);
        font-size: 14px;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
      }
      
      .marker-shadow {
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 8px;
        background: radial-gradient(ellipse, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
        border-radius: 50%;
        filter: blur(2px);
      }
      
      .modern-marker:hover .marker-pin {
        box-shadow: 0 8px 25px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.1);
      }
      
      .modern-marker:hover .marker-shadow {
        transform: translateX(-50%) scale(1.2);
        opacity: 0.8;
      }

      /* ===== modern glassmorphism popup ===== */
      .maplibregl-popup {
        max-width: 280px !important;
      }
      .maplibregl-popup-content {
        padding: 0;
        border-radius: 20px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.05);
        animation: popupSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .maplibregl-popup-close-button {
        top: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #666;
        transition: all 0.2s ease;
      }
      .maplibregl-popup-close-button:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.1);
      }
      
      @keyframes popupSlideIn {
        from {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .card {
        width: 280px;
        max-height: 400px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
      }
      
      .card::-webkit-scrollbar {
        width: 6px;
      }
      
      .card::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .card::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }
      
      .card::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }
      
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      }
      
      .card_media {
        position: relative;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        overflow: hidden;
      }
      
      .card_img {
        display: block;
        width: 100%;
        height: 180px;
        object-fit: cover;
        transition: transform 0.3s ease;
      }
      
      .card_media:hover .card_img {
        transform: scale(1.05);
      }
      
      .card_body {
        padding: 20px;
        font: 14px/1.5 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: #1a202c;
      }
      
      .card_title {
        margin: 0 0 8px;
        font-size: 18px;
        font-weight: 700;
        color: #2d3748;
        line-height: 1.3;
      }
      
      .muted {
        color: #718096;
        font-size: 13px;
        margin: 4px 0;
      }
      
      .card_link {
        color: #3182ce;
        text-decoration: none;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      
      .card_link:hover {
        color: #2c5282;
        transform: translateX(2px);
      }
      
      .card_link::after {
        content: '‚Üó';
        font-size: 12px;
        transition: transform 0.2s ease;
      }
      
      .card_link:hover::after {
        transform: translate(2px, -2px);
      }

      /* ===== Map Controls ===== */
      .map-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 300px;
      }
      
      .search-container {
        display: flex;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      #searchInput {
        flex: 1;
        border: none;
        background: transparent;
        padding: 8px 12px;
        font-size: 14px;
        outline: none;
        color: #333;
      }
      
      #searchInput::placeholder {
        color: #666;
      }
      
      #searchBtn {
        background: #3182ce;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        color: white;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s ease;
      }
      
      #searchBtn:hover {
        background: #2c5282;
        transform: scale(1.05);
      }
      
      .category-filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .filter-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #666;
      }
      
      .filter-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .filter-btn.active {
        background: #3182ce;
        color: white;
        border-color: #3182ce;
      }
      
      .filter-btn[data-category="Zanat"].active {
        background: #F4A261;
        border-color: #F4A261;
      }
      
      .filter-btn[data-category="Proizvodi"].active {
        background: #8B4513;
        border-color: #8B4513;
      }
      
      .filter-btn[data-category="Usluge"].active {
        background: #20B2AA;
        border-color: #20B2AA;
      }
      
      .filter-btn[data-category="Manifestacije"].active {
        background: #DC143C;
        border-color: #DC143C;
      }

      /* carousel kontrole */
      .navbtn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 26px;
        height: 26px;
        border: none;
        border-radius: 99px;
        background: rgba(255, 255, 255, 0.95);
        display: grid;
        place-items: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        cursor: pointer;
      }
      .navbtn--prev {
        left: 8px;
      }
      .navbtn--next {
        right: 8px;
      }
      .dots {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 6px;
        display: flex;
        gap: 6px;
        justify-content: center;
      }
      .dots i {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
      }
      .dots i.on {
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    
    <!-- Search and Filter Controls -->
    <div class="map-controls">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Pretra≈æi lokacije..." />
        <button id="searchBtn">üîç</button>
      </div>
      
      <div class="category-filters">
        <button class="filter-btn active" data-category="all">Sve</button>
        <button class="filter-btn" data-category="Zanat">Zanati</button>
        <button class="filter-btn" data-category="Proizvodi">Proizvodi</button>
        <button class="filter-btn" data-category="Usluge">Usluge</button>
        <button class="filter-btn" data-category="Manifestacije">Manifestacije</button>
      </div>
    </div>
    

    <script>
      // 1) Map style (MapTiler) - Analysis: We're using MapTiler for:
      // - Base map tiles (satellite/street view)
      // - Geocoding (in csv2geojson.js)
      // - Map styling and themes
      // Alternative: OpenStreetMap (free) or Mapbox (paid)
      const MAPTILER_KEY = "WJJJqPPstboZWo4827qc";
      const STYLE_URL = `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`;
      
      // Alternative free map styles:
      // const STYLE_URL = 'https://api.maptiler.com/maps/basic-v2/style.json?key=' + MAPTILER_KEY;
      // const STYLE_URL = 'https://api.maptiler.com/maps/outdoor-v2/style.json?key=' + MAPTILER_KEY;
      // const STYLE_URL = 'https://api.maptiler.com/maps/satellite/style.json?key=' + MAPTILER_KEY;

      // 2) Init mapa
      const map = new maplibregl.Map({
        container: "map",
        style: STYLE_URL,
        center: [19.8335, 45.2671],
        zoom: 7.2,
        attributionControl: true,
      });
      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // 3) Uƒçitavanje podataka
      async function loadData() {
        const r = await fetch("/data/places.geojson", { cache: "no-store" });
        if (!r.ok) throw new Error("Ne mogu da uƒçitam /data/places.geojson");
        return r.json();
      }
      
      // 4) INLINE SVG MARKERA (popunjen, kontrastan)
      //   ‚Äì nema fetch-a ‚Üí nema CORS/404; lako menja≈° boje/veliƒçinu
      const PIN_SVG = `
        <svg viewBox="0 0 40 52" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="pinGradient" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#1f7a8c"/>
              <stop offset="1" stop-color="#176273"/>
            </linearGradient>
          </defs>
          <!-- telo pina - puno, bez providnosti -->
          <path d="M20 1C10.1 1 2 9.1 2 19c0 10.3 9 19.5 16.2 30.7a2 2 0 0 0 3.5 0C29 38.5 38 29.3 38 19 38 9.1 29.9 1 20 1z"
                fill="url(#pinGradient)" stroke="#0e3d45" stroke-width="2"/>
          <!-- bela ploƒçica unutra -->
          <circle cx="20" cy="19" r="10.5" fill="#ffffff" stroke="#0e3d45" stroke-width="1.5"/>
          <!-- alatke (ikonica zanata) -->
          <path d="M16.2 14.5l-3 2.8a.9.9 0 0 0 0 1.3l2 2a.9.9 0 0 0 1.3 0l2.8-3 4.7 4.7a1 1 0 0 0 1.4 0l1-1a1 1 0 0 0 0-1.4l-4.8-4.7 3-2.9a.9.9 0 0 0 0-1.3l-2-2a.9.9 0 0 0-1.2 0l-2.9 3-2-2a.9.9 0 0 0-1.3 0l-1 1a.9.9 0 0 0 0 1.3l2 1.9z"
                fill="#0e3d45"/>
        </svg>`;

      // Test marker - simple red circle
      const TEST_MARKER = `
        <div style="width: 30px; height: 30px; background: red; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
      `;
      
      // Modern marker design with category colors
      const createModernMarker = (category) => {
        const colors = {
          'Zanat': { primary: '#F4A261', secondary: '#E76F51', icon: 'üî®' }, // Saffron
          'Proizvodi': { primary: '#8B4513', secondary: '#A0522D', icon: 'üì¶' }, // Chestnut
          'Usluge': { primary: '#20B2AA', secondary: '#40E0D0', icon: 'üõ†Ô∏è' }, // Teal
          'Manifestacije': { primary: '#DC143C', secondary: '#FF6347', icon: 'üé™' }, // Carmine
          'default': { primary: '#1F7A8C', secondary: '#4A9BB5', icon: 'üìç' }
        };
        
        const color = colors[category] || colors.default;
        
        // Try to use custom SVG logo for Zanat category
        if (category === 'Zanat') {
          return `
            <div class="modern-marker" data-category="${category}">
              <div class="marker-pin" style="
                background: linear-gradient(135deg, ${color.primary} 0%, ${color.secondary} 100%);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
              ">
                <div class="marker-icon">
                  <img src="/img/kategorije/zanati.svg" alt="Zanat" style="width: 20px; height: 20px;" />
                </div>
              </div>
              <div class="marker-shadow"></div>
            </div>
          `;
        }
        
        return `
          <div class="modern-marker" data-category="${category}">
            <div class="marker-pin" style="
              background: linear-gradient(135deg, ${color.primary} 0%, ${color.secondary} 100%);
              box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
            ">
              <div class="marker-icon">${color.icon}</div>
            </div>
            <div class="marker-shadow"></div>
          </div>
        `;
      };

      // Cache busting for development
      console.log('NIV Map loaded - version:', new Date().toISOString());
      console.log('PIN_SVG length:', PIN_SVG.length);
      console.log('PIN_SVG preview:', PIN_SVG.substring(0, 100) + '...');

      // helper: normalizuj CSV foto listu ‚Üí apsolutni put
      // SAMO fotke iz CSV/GeoJSON (bez fallbacka)
      const normPhotos = (fotoString) => {
        if (!fotoString) return [];
        return String(fotoString)
          .split(',')
          .map(s => s.trim())
          .filter(Boolean)
          .filter(u => /\.(png|jpe?g|webp|gif|svg)$/i.test(u))
          .map(u => u.startsWith('/') ? u : `/${u}`);
      };

      // popup HTML + carousel
      function buildCarousel(arr, alt) {
        if (!arr.length) return "";
        const dots = arr
          .map((_, i) => `<i class="${i === 0 ? "on" : ""}"></i>`)
          .join("");
        return `
          <div class="card_media" data-count="${arr.length}">
            <img class="card_img" src="${arr[0]}" alt="${
          alt || "Foto"
        }" data-idx="0"/>
            ${
              arr.length > 1
                ? `
              <button class="navbtn navbtn--prev" aria-label="Prethodna">‚Äπ</button>
              <button class="navbtn navbtn--next" aria-label="Sledeƒáa">‚Ä∫</button>
              <div class="dots">${dots}</div>`
                : ""
            }
          </div>`;
      }
      function popupHTML(p) {
        const photos = normPhotos(p.foto);
        return `
          <article class="card">
            ${buildCarousel(photos, p.naziv)}
            <div class="card_body">
              <h3 class="card_title">${p.naziv ?? ""}</h3>
              ${
                p.kategorija
                  ? `<div class="muted"><strong>Kategorija:</strong> ${p.kategorija}</div>`
                  : ""
              }
              ${
                p.opis
                  ? `<p class="muted" style="margin:.45rem 0 0">${p.opis}</p>`
                  : ""
              }
              ${
                p.web
                  ? `<p style="margin:.55rem 0 0"><a class="card_link" href="${p.web}" target="_blank" rel="noopener">Web sajt ‚áó</a></p>`
                  : ""
              }
            </div>
          </article>`;
      }
      function wireCarousel(container, items) {
        const wrap = container.querySelector(".card_media");
        if (!wrap) return;
        const img = wrap.querySelector(".card_img");
        const prev = wrap.querySelector(".navbtn--prev");
        const next = wrap.querySelector(".navbtn--next");
        const dots = wrap.querySelectorAll(".dots i");
        let idx = 0;
        let startX = 0;
        let startY = 0;
        let isDragging = false;
        
        const go = (to) => {
          idx = (to + items.length) % items.length;
          img.src = items[idx];
          img.dataset.idx = String(idx);
          dots.forEach((d, i) => d.classList.toggle("on", i === idx));
        };
        
        // Touch/swipe support for mobile
        wrap.addEventListener("touchstart", (e) => {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          isDragging = true;
        });
        
        wrap.addEventListener("touchmove", (e) => {
          if (!isDragging) return;
          e.preventDefault();
        });
        
        wrap.addEventListener("touchend", (e) => {
          if (!isDragging) return;
          isDragging = false;
          
          const endX = e.changedTouches[0].clientX;
          const endY = e.changedTouches[0].clientY;
          const diffX = startX - endX;
          const diffY = startY - endY;
          
          // Only trigger swipe if horizontal movement is greater than vertical
          if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0) {
              go(idx + 1); // Swipe left - next image
            } else {
              go(idx - 1); // Swipe right - previous image
            }
          }
        });
        
        // Mouse drag support for desktop
        wrap.addEventListener("mousedown", (e) => {
          startX = e.clientX;
          isDragging = true;
          e.preventDefault();
        });
        
        wrap.addEventListener("mousemove", (e) => {
          if (!isDragging) return;
          e.preventDefault();
        });
        
        wrap.addEventListener("mouseup", (e) => {
          if (!isDragging) return;
          isDragging = false;
          
          const endX = e.clientX;
          const diffX = startX - endX;
          
          if (Math.abs(diffX) > 50) {
            if (diffX > 0) {
              go(idx + 1);
            } else {
              go(idx - 1);
            }
          }
        });
        
        // Button controls
        prev &&
          prev.addEventListener("click", (e) => {
            e.stopPropagation();
            go(idx - 1);
          });
        next &&
          next.addEventListener("click", (e) => {
            e.stopPropagation();
            go(idx + 1);
          });
        dots.forEach((d, i) =>
          d.addEventListener("click", (e) => {
            e.stopPropagation();
            go(i);
          })
        );
      }

      map.on("load", async () => {
        const data = await loadData();
        const popup = new maplibregl.Popup({
          closeButton: true,
          closeOnClick: true,
        });

        // Add data source
        map.addSource('places', {
          type: 'geojson',
          data: data
        });

        // Use proper MapLibre markers with custom elements
        const markers = [];
        
        data.features.forEach((f) => {
          const p = f.properties || {};
          const [lng, lat] = f.geometry.coordinates;

          // Create modern marker with category-based styling
          const el = document.createElement("div");
          el.className = "modern-marker";
          el.innerHTML = createModernMarker(p.kategorija);
          
          console.log('Creating marker for:', p.naziv, 'at', [lng, lat]); // debug
          console.log('Element HTML:', el.outerHTML.substring(0, 200)); // debug
          
          // Use MapLibre Marker with custom element
          const marker = new maplibregl.Marker({
            element: el,
            anchor: 'bottom'
          })
            .setLngLat([lng, lat])
            .addTo(map);
          
          // Store marker info
          markers.push({
            marker: marker,
            element: el,
            lngLat: [lng, lat],
            properties: p
          });

          // Klik na marker - toggle popup
          el.addEventListener("click", (e) => {
            e.stopPropagation();
            e.preventDefault();
            
            // Check if popup is already open for this marker
            const existingPopup = document.querySelector('.maplibregl-popup');
            if (existingPopup) {
              // Close existing popup
              popup.remove();
              return;
            }
            
            const photos = normPhotos(p.foto);
            console.log('Marker clicked, photos:', photos); // debug
            
            popup.setLngLat([lng, lat]).setHTML(popupHTML(p)).addTo(map);
            
            // Ve≈æemo karusel nakon ≈°to je popup u DOM-u
            setTimeout(() => {
              const container = document.querySelector(".maplibregl-popup-content");
              if (container && photos.length > 1) {
                wireCarousel(container, photos);
              }
            }, 100);
          });
        });
        
        // Search and Filter Functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        let currentFilter = 'all';
        let allMarkers = [...markers]; // Keep reference to all markers
        
        // Search functionality
        function performSearch() {
          const query = searchInput.value.toLowerCase().trim();
          if (!query) {
            // Show all markers
            allMarkers.forEach(marker => {
              marker.marker.getElement().style.display = 'block';
            });
            return;
          }
          
          // Filter markers based on search query
          allMarkers.forEach(marker => {
            const props = marker.properties;
            const searchText = `${props.naziv} ${props.kategorija} ${props.mesto} ${props.opis}`.toLowerCase();
            
            if (searchText.includes(query)) {
              marker.marker.getElement().style.display = 'block';
            } else {
              marker.marker.getElement().style.display = 'none';
            }
          });
        }
        
        // Category filtering
        function filterByCategory(category) {
          currentFilter = category;
          
          // Update filter buttons
          filterBtns.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.category === category) {
              btn.classList.add('active');
            }
          });
          
          // Filter markers
          allMarkers.forEach(marker => {
            const markerCategory = marker.properties.kategorija;
            
            if (category === 'all' || markerCategory === category) {
              marker.marker.getElement().style.display = 'block';
            } else {
              marker.marker.getElement().style.display = 'none';
            }
          });
        }
        
        // Event listeners
        searchInput.addEventListener('input', performSearch);
        searchBtn.addEventListener('click', performSearch);
        
        filterBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            filterByCategory(btn.dataset.category);
          });
        });
        
        // Clear search on escape
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            searchInput.value = '';
            performSearch();
          }
        });
      });
    </script>
  </body>
</html>
